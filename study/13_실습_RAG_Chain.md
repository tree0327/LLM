# ì‹¤ìŠµ 13: RAG ì²´ì¸ (ë“œë””ì–´ í•©ì²´!) ğŸ”—ğŸš€

ì•„í‚¤í…íŠ¸ë‹˜, ì´ì œ **"ë„ì„œê´€(RAG)"**ê³¼ **"ìë™í™” ê³µì¥(Chain)"**ì„ í•©ì¹  ì‹œê°„ì…ë‹ˆë‹¤.
ì´ ì½”ë“œê°€ ë°”ë¡œ ìš°ë¦¬ê°€ ì§€ê¸ˆê¹Œì§€ ë‹¬ë ¤ì˜¨ **ìµœì¢… ëª©í‘œ**ì…ë‹ˆë‹¤.

---

## 1. ìˆ˜ë™ vs ìë™ ë¹„êµ

### ğŸ˜« ìˆ˜ë™ ë°©ì‹ (ìš°ë¦¬ê°€ í–ˆë˜ ê²ƒ)
```python
# 1. ë¬¸ì„œ ì°¾ê¸°
docs = retriever.invoke(ì§ˆë¬¸)
# 2. í”„ë¡¬í”„íŠ¸ì— ë¼ì›Œë„£ê¸°
prompt_val = prompt.format(context=docs, question=ì§ˆë¬¸)
# 3. ëª¨ë¸ ëŒë¦¬ê¸°
response = llm.invoke(prompt_val)
```

### ğŸ˜ ì²´ì¸ ë°©ì‹ (ìš°ë¦¬ê°€ í•  ê²ƒ)
```python
# í•œ ë°©ì— ì—°ê²°
chain = (ê²€ìƒ‰ | í”„ë¡¬í”„íŠ¸ | ëª¨ë¸ | íŒŒì„œ)
chain.invoke(ì§ˆë¬¸)
```

---

## 2. í•µì‹¬ ê°œë…: ë‘ ì†ìœ¼ë¡œ ë°›ê¸° (`dict`)

í”„ë¡¬í”„íŠ¸ëŠ” **ë‘ ê°€ì§€ ì¬ë£Œ**ê°€ í•„ìš”í•©ë‹ˆë‹¤.
1.  **`context`**: ê²€ìƒ‰ëœ ë¬¸ì„œ ë‚´ìš© (ì»¨ë‹ í˜ì´í¼)
2.  **`question`**: ì‚¬ìš©ìì˜ ì§ˆë¬¸

ê·¸ë˜ì„œ ì²´ì¸ì˜ ë§¨ ì•ë‹¨ì—ì„œ **ì§€ë„ë¥¼ ê·¸ë ¤ì¤˜ì•¼(Map)** í•©ë‹ˆë‹¤.

> "ì, `context`ëŠ” ê²€ìƒ‰ê¸°(retriever)í•œí…Œê°€ì„œ ë°›ì•„ì˜¤ê³ ,
> `question`ì€ ì‚¬ìš©ìê°€ ì¤€ ê±° ê·¸ëŒ€ë¡œ ì¨!"

```python
setup = {
    "context": retriever,          # ê²€ìƒ‰í•´ì„œ ì±„ì›Œë¼!
    "question": RunnablePassthrough() # ê·¸ëƒ¥ í†µê³¼ì‹œì¼œë¼! (Pass-Through)
}
```

---

## 3. ì „ì²´ ì½”ë“œ (ë³µì‚¬í•´ì„œ ì‹¤í–‰í•˜ì„¸ìš”)

`study/11_ì‹¤ìŠµ_RAG_ì£¼ì„í¬í•¨.md`ì—ì„œ ì¼ë˜ `vector_db`ê°€ ë©”ëª¨ë¦¬ì— ìˆë‹¤ê³  ê°€ì •í•©ë‹ˆë‹¤.
(ì—†ìœ¼ë©´ 11ë²ˆ ì‹¤ìŠµì„ ë¨¼ì € ì‹¤í–‰í•´ì£¼ì„¸ìš”!)

```python
from langchain_core.runnables import RunnablePassthrough
from langchain_core.output_parsers import StrOutputParser
from langchain_core.prompts import ChatPromptTemplate

# 1. ê²€ìƒ‰ê¸° ì¤€ë¹„ (ì‚¬ì„œ í˜¸ì¶œ)
retriever = vector_db.as_retriever(search_kwargs={"k": 1})

# 2. í”„ë¡¬í”„íŠ¸ ì¤€ë¹„ (êµ¬ë©ì´ 2ê°œ!)
template = """
ë‹¹ì‹ ì€ ì¹œì ˆí•œ AIì…ë‹ˆë‹¤. ì•„ë˜ ë‚´ìš©ì„ ì°¸ê³ í•´ì„œ ì§ˆë¬¸ì— ë‹µí•˜ì„¸ìš”.

[ì°¸ê³  ë¬¸ì„œ]
{context}

[ì§ˆë¬¸]
{question}
"""
prompt = ChatPromptTemplate.from_template(template)

# 3. ëª¨ë¸ ì¤€ë¹„
model = ChatOpenAI(model="gpt-4o-mini", temperature=0)

# 4. ì²´ì¸ ì¡°ë¦½ (ì—¬ê¸°ê°€ í•˜ì´ë¼ì´íŠ¸! âœ¨)
rag_chain = (
    {"context": retriever, "question": RunnablePassthrough()} 
    | prompt 
    | model 
    | StrOutputParser()
)

# 5. ì‹¤í–‰ (ë²„íŠ¼ ê¾¹!)
result = rag_chain.invoke("ë³µì§€ í¬ì¸íŠ¸ ì–¼ë§ˆì•¼?")

print("=== AIì˜ ë‹µë³€ ===")
print(result)
```

## ğŸ¦ ì½”ë“œ í•´ì„
1.  **`{"context": retriever, ...}`**: ì‚¬ìš©ìê°€ ì§ˆë¬¸("ë³µì§€ í¬ì¸íŠ¸?")ì„ ë˜ì§€ë©´,
    *   í•˜ë‚˜ëŠ” `retriever`ë¡œ ê°€ì„œ ë¬¸ì„œë¥¼ ì°¾ì•„ì˜¤ê³  (`context` ì±„ì›€)
    *   í•˜ë‚˜ëŠ” ê·¸ëŒ€ë¡œ `question` ìë¦¬ë¡œ ë“¤ì–´ê°‘ë‹ˆë‹¤.
2.  **`| prompt`**: ê½‰ ì°¬ ì¬ë£Œë¥¼ í”„ë¡¬í”„íŠ¸ í‹€ì— ë¶“ìŠµë‹ˆë‹¤.
3.  **`| model`**: ëª¨ë¸ì´ ì½ê³  ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤.
4.  **`| parser`**: ê¹”ë”í•œ ë¬¸ìì—´ë¡œ í¬ì¥í•©ë‹ˆë‹¤.

ì´ì œ **ë‹¨ í•œ ì¤„(`invoke`)**ë¡œ ê²€ìƒ‰ë¶€í„° ë‹µë³€ê¹Œì§€ ëë‚©ë‹ˆë‹¤.
ì´ ë§›ì— ë­ì²´ì¸ì„ ì”ë‹ˆë‹¤! ë©! ğŸ¶
